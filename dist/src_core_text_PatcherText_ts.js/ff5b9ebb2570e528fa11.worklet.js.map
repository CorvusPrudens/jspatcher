{"version":3,"sources":["webpack://JSPatcher/JSPatcher/JSPatcher/JSPatcher/JSPatcher/./src/core/text/PatcherText.ts","webpack://JSPatcher/JSPatcher/JSPatcher/JSPatcher/JSPatcher/./src/core/text/TextEditor.ts","webpack://JSPatcher/JSPatcher/JSPatcher/JSPatcher/JSPatcher/./src/core/text/TextHistory.ts"],"names":["PatcherText","FileInstance","TextHistory","fromProjectItem","options","init","file","data","getEditor","editor","TextEditor","text","Response","_isReady","emit","serialize","Blob","arrayBuffer","clone","patcherText","env","project","FileEditor","instanceId","TempTextFile","instantiate","fileExtension","fileIcon","instance","value","isReady","Promise","resolve","reject","handleReady","off","on","editorLanguage","name","endsWith","bindEditor","didChanged","onDidChangeModelContent","e","oldText","getValue","didDispose","onDidDispose","dispose","undefined","addAction","id","label","keybindings","run","save","copy","focus","document","execCommand","cut","paste","navigator","clipboard","readText","executeEdits","range","getSelection","forceMoveMarkers","deleteSelected","selectAll","getModel","getFullModelRange","setSelection","onUiResized","History","eventListening","undoOf","eventName","eventData","undo","redoOf","redo"],"mappings":"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","file":"src_core_text_PatcherText_ts.js/ff5b9ebb2570e528fa11.worklet.js","sourcesContent":["import FileInstance from \"../file/FileInstance\";\nimport TextEditor from \"./TextEditor\";\nimport TempTextFile from \"./TempTextFile\";\nimport TextHistory from \"./TextHistory\";\nimport type PersistentProjectFile from \"../file/PersistentProjectFile\";\nimport type { IJSPatcherEnv } from \"../Env\";\nimport type { IProject } from \"../Project\";\n\nexport interface PatcherTextEventMap {\n    \"textModified\": { text: string; oldText: string };\n}\n\nexport default class PatcherText extends FileInstance<PatcherTextEventMap, PersistentProjectFile | TempTextFile> {\n    static async fromProjectItem(options: { file: PersistentProjectFile; env: IJSPatcherEnv; project?: IProject; instanceId?: string }) {\n        return new this(options).init(options.file.data);\n    }\n    text: string;\n    _history = new TextHistory();\n    async getEditor() {\n        const editor = new TextEditor(this);\n        return editor.init();\n    }\n    async init(data?: ArrayBuffer) {\n        if (data) this.text = await new Response(data).text();\n        else this.text = \"\";\n        this._isReady = true;\n        this.emit(\"ready\");\n        return this;\n    }\n    async serialize() {\n        return new Blob([this.text]).arrayBuffer();\n    }\n    clone() {\n        const patcherText = new PatcherText({ env: this.env, project: this.project, file: this.file });\n        patcherText.text = this.text;\n        return patcherText;\n    }\n}\n","import type { SemanticICONS } from \"semantic-ui-react\";\nimport type MonacoEditor from \"react-monaco-editor\";\nimport type { editor } from \"monaco-editor/esm/vs/editor/editor.api\";\nimport FileEditor from \"../file/FileEditor\";\nimport TempTextFile from \"./TempTextFile\";\nimport type PatcherText from \"./PatcherText\";\nimport type PersistentProjectFile from \"../file/PersistentProjectFile\";\nimport type { IJSPatcherEnv } from \"../Env\";\nimport type { IProject } from \"../Project\";\n\nexport interface TextEditorEventMap {\n    \"textModified\": { text: string; oldText: string };\n}\n\nexport interface TextHistoryEventMap extends TextEditorEventMap {}\n\nexport default class TextEditor extends FileEditor<PatcherText, TextEditorEventMap> {\n    static async fromProjectItem({ file, env, project, instanceId }: { file: PersistentProjectFile | TempTextFile; env: IJSPatcherEnv; project?: IProject; instanceId?: string }) {\n        const text = file instanceof TempTextFile ? file.data : await file.instantiate({ env, project, instanceId }) as PatcherText;\n        const editor = new this(text);\n        return editor.init();\n    }\n    editor: editor.IStandaloneCodeEditor;\n    editorJSX: typeof MonacoEditor;\n    get fileExtension() {\n        return \"txt\";\n    }\n    get fileIcon(): SemanticICONS {\n        return \"code\";\n    }\n    get text() {\n        return this.instance.text;\n    }\n    set text(value: string) {\n        this.instance.text = value;\n    }\n    async init() {\n        if (!this.instance.isReady) {\n            await new Promise<void>((resolve, reject) => {\n                const handleReady = () => {\n                    resolve();\n                    this.instance.off(\"ready\", handleReady);\n                };\n                this.instance.on(\"ready\", handleReady);\n            });\n        }\n        this._isReady = true;\n        this.emit(\"ready\");\n        return this;\n    }\n    get editorLanguage() {\n        if (!this.file) return \"none\";\n        if (this.file.name.endsWith(\".js\")) return \"js\";\n        if (this.file.name.endsWith(\".json\")) return \"json\";\n        if (this.file.name.endsWith(\".html\")) return \"html\";\n        if (this.file.name.endsWith(\".dsp\")) return \"faust\";\n        return \"none\";\n    }\n    bindEditor(editor: editor.IStandaloneCodeEditor) {\n        this.editor = editor;\n        const didChanged = editor.onDidChangeModelContent((e) => {\n            const oldText = this.text;\n            const text = editor.getValue();\n            this.text = text;\n            this.emit(\"textModified\", { text, oldText });\n            this.emit(\"changed\");\n        });\n        const didDispose = editor.onDidDispose(() => {\n            didChanged.dispose();\n            didDispose.dispose();\n            this.editor = undefined;\n            this.emit(\"destroy\");\n        });\n        editor.addAction({\n            id: \"editor.action.save\",\n            label: \"Save\",\n            keybindings: [/* KeyMod.CtrlCmd */2048 | /* KeyCode.KEY_S */49],\n            run: () => this.save()\n        });\n    }\n    async copy() {\n        if (!this.editor) return;\n        this.editor.focus();\n        document.execCommand(\"copy\");\n    }\n    async cut() {\n        if (!this.editor) return;\n        this.editor.focus();\n        document.execCommand(\"cut\");\n    }\n    async paste() {\n        if (!this.editor) return;\n        this.editor.focus();\n        const text = await navigator.clipboard.readText();\n        this.editor.executeEdits(\"\", [{ range: this.editor.getSelection(), text, forceMoveMarkers: true }]);\n    }\n    async deleteSelected() {\n        if (!this.editor) return;\n        this.editor.executeEdits(\"\", [{ range: this.editor.getSelection(), text: null }]);\n    }\n    async selectAll() {\n        if (!this.editor) return;\n        const range = this.editor.getModel().getFullModelRange();\n        this.editor.setSelection(range);\n    }\n    onUiResized() {}\n}\n","import History from \"../file/History\";\nimport TextEditor, { TextHistoryEventMap } from \"./TextEditor\";\n\nexport default class TextHistory extends History<TextHistoryEventMap, TextEditor> {\n    get eventListening(): (keyof TextHistoryEventMap)[] {\n        return [\"textModified\"];\n    }\n    async undoOf(editor: TextEditor, eventName: keyof TextHistoryEventMap, eventData: any) {\n        if (eventName === \"textModified\") {\n            const e: TextHistoryEventMap[typeof eventName] = eventData;\n            const { oldText } = e;\n            if (editor.editor) {\n                editor.editor.focus();\n                if (!document.execCommand(\"undo\")) {\n                    (editor.editor.getModel() as any)?.undo();\n                }\n                editor.text = editor.editor.getValue();\n                e.oldText = editor.text;\n            } else {\n                editor.text = oldText;\n            }\n        }\n    }\n    async redoOf(editor: TextEditor, eventName: keyof TextHistoryEventMap, eventData: any) {\n        if (eventName === \"textModified\") {\n            const e: TextHistoryEventMap[typeof eventName] = eventData;\n            const { text } = e;\n            if (editor.editor) {\n                editor.editor.focus();\n                if (!document.execCommand(\"undo\")) {\n                    (editor.editor.getModel() as any)?.redo();\n                }\n                editor.text = editor.editor.getValue();\n                e.text = editor.text;\n            } else {\n                editor.text = text;\n            }\n        }\n    }\n}\n"],"sourceRoot":""}